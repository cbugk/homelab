# Documentation of creating a template for base RKE vms

#-Prerequisite(s):
homelab/proxmox/ubuntu_20.04_cloud-init_template.txt

#-Source(s):
#   [tag:brandstetter]  https://norocketscience.at/deploy-proxmox-virtual-machines-using-cloud-init/
#   [tag:oliveira]      https://medium.com/swlh/provision-proxmox-vms-with-terraform-quick-and-easy-5ad1975df1de

#-Environment:
#   Workstation: 32-bit Windows10Pro Netbook
#     Shell: Git Bash (Admin)
#     User: cbugra@workstation
#   Proxmox 6.2 Cluster
#     Nodes: [ apollo, hermes, triton ]
#     Domain: pve.cbk.lab
#     Storage: [ CephFS: cephfs, RADOS: cephrds ]
#     VM: [ id: 9000, template: true, name: "ubuntu-2004-cloudinit-template" ]

#-End-Result:
#   VM for RKE node, with required packages/binaries installed and virtual hardware specified

#-Procedure----------

# Create cluster-wide public key directory
#  cbugra@workstation:/c/ssh_keys/rke_vm/
     ssh root@hermes.pve.cbk.lab mkdir -p /etc/pve/pub_keys

# Upload ssh public key onto cluster-wide directory
#  cbugra@workstation:/c/ssh_keys/rke_vm/
     scp ./rke_vm.pub root@hermes.pve.cbk.lab:/etc/pve/pub_keys/

# Enter into the node
#  cbugra@workstation:/c/ssh_keys/rke_vm/
     ssh root@hermes.pve.cbk.lab

# Clone template to further configure
#  root@hermes:/root/
     qm clone 9000 9100 --name rke-base-template

# Set ssh authentication from uploaded public key
#  root@hermes:/root/
     qm set 9100 --sshkey /etc/pve/pub_keys/rke_vm.pub

# Change Hardware as required/desired
#  root@hermes:/root/
     qm set 9100 --cores 2 --memory 6144

# Optionally set static-ip
#  root@hermes:/root/
     qm set 9100 --ipconfig0 ip=192.168.1.91/24,gw=192.168.1.1

# Note setting default user requires snippet on a volume
# Not configured as of now, default user is "ubuntu"

# Start VM (not a template yet)
# You are advised to check options on GUI beforehand, update as you wish via GUI/CLI
#  root@hermes:/root/
     qm start 9100

# Exit from the node
#  root@hermes:/root/
     exit

# Enter into RKE base vm
#  cbugra@workstation:/c/ssh_keys/rke_vm/
     ssh -i ./rke_vm.ssh ubuntu@192.168.1.91

# Obligatory apt update/upgrade
#  ubuntu@rke-base-template:/home/ubuntu/
     sudo apt update && sudo apt upgrade

# Add password (sudo did not ask any for last step)
#  ubuntu@rke-base-template:/home/ubuntu/
     sudo passwd ubuntu

  