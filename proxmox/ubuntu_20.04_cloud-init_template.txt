# Documentation for initial preparation of Ubuntu colud-init template on Proxmox

#-Source(s):
#   [tag:brandstetter]  https://norocketscience.at/deploy-proxmox-virtual-machines-using-cloud-init/
#   [tag:oliveira]      https://medium.com/swlh/provision-proxmox-vms-with-terraform-quick-and-easy-5ad1975df1de

#-Environment:
#   Workstation: 32-bit Windows10Pro Netbook
#     Shell: Git Bash (Admin)
#     User: cbugra@workstation
#   Proxmox 6.2 Cluster
#     Nodes: [ apollo, hermes, triton ]
#     Domain: pve.cbk.lab
#     Storage: [ CephFS: cephfs, RADOS: cephrds ]

#-End-Result:

#-Procedure----------

# Download official cloudimage from Canonical (Focal Fossa 20.04)
#  cbugra@workstation:/c/boot_img/qcow2/
     wget https://cloud-images.ubuntu.com/focal/current/focal-server-cloudimg-amd64.img

# Do NOT forget to rename extention from ".img" to ".qcow2" as also described in proxmox forum
#  cbugra@workstation:/c/boot_img/qcow2/
     mv focal-server-cloudimg-amd64.img focal-server-cloudimg-amd64.qcow2

# Upload file to a cluster node
#  cbugra@workstation:/c/boot_img/qcow2/
     scp ./focal-server-cloudimg-amd64.qcow2 root@hermes.pve.cbk.lab:/root/

# Enter into the node
#  cbugra@workstation:/c/boot_img/qcow2/
     ssh root@hermes.pve.cbk.lab

# Create vm scaffold
#  root@hermes:/root/
    qm create 9000 --name ubuntu-2004-cloudinit-template --memory 1024 --net0 virtio,bridge=vmbr0 --cores 1 --sockets 1 --cpu cputype=kvm64 -description “ubuntu-2004-cloudinit-template” --kvm 1 --numa 1

# Import .qcow2 image as disk
#  root@hermes:/root/
     qm importdisk 9000 /root/focal-server-cloudimg-amd64.qcow2 cephrds

# Optionally delete key as no more required
#  root@hermes:/root/
     rm /root/focal-server-cloudimg-amd64.qcow2

# Vm template to use disk 
#  root@hermes:/root/
     qm set 9000 --scsihw virtio-scsi-pci --virtio0 cephrds:vm-9000-disk-0

# Set serial, told it is required for Openstack cloudinit images
#  root@hermes:/root/
     qm set 9000 --serial0 socket

# Set vga
#  root@hermes:/root/
     qm set 9000 --vga qxl

# Cloud-init configuration is handed from CD-Rom
#  root@hermes:/root/
     qm set 9000 --ide2 cephrds:cloudinit

# Set boot order (boot disk only)
#  root@hermes:/root/
     qm set 9000 --boot c --bootdisk scsi0

# Acknowlegde image has qemu-agent support (aware of being a vm)
#  root@hermes:/root/
     qm set 9000 --agent 1

# Turn into template at last
#  root@hermes:/root/
     qm template 9000

# Exit from the node
#  root@hermes:/root/
     exit

#-Procedure-End------